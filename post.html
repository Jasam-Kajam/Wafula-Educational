<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>View Post</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: Georgia, serif; max-width: 800px; margin: auto; padding: 20px; background: #f5f5f5; color: #333; }
    #coverImage { width: 100%; max-height: 400px; object-fit: cover; margin-bottom: 20px; border-radius: 8px; display: none; }
    h1#postTitle { font-size: 2.6em; font-weight: bold; color: #0d47a1; border-bottom: 4px solid #0d47a1; padding-bottom: 10px; margin-bottom: 5px; }
    .post-category { display: inline-block; background: #ff6f00; color: white; font-size: 0.95em; font-weight: bold; padding: 6px 12px; border-radius: 20px; margin-top: 10px; margin-bottom: 5px; }
    .post-meta { font-size: 0.9em; color: #555; margin-bottom: 25px; }
    iframe, img, video { max-width: 100%; height: auto; margin-top: 15px; border-radius: 6px; }
    #postContent img { max-width: 48%; height: auto; border-radius: 6px; margin: 0 0 1rem 0; }
    #postContent img:nth-of-type(odd) { float: left; margin: 0 1rem 1rem 0; }
    #postContent img:nth-of-type(even) { float: right; margin: 0 0 1rem 1rem; }
    #postContent::after { content: ""; display: table; clear: both; }
    @media (max-width: 600px) { #postContent img { max-width: 100%; float: none; display: block; margin: 1rem auto; } }
  </style>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
</head>

<body>
  <img id="coverImage" alt="Cover Image" />
  <h1 id="postTitle">Loading...</h1>
  <div class="post-category" id="postCategory"></div>
  <div class="post-meta" id="postMeta"></div>
  <div id="postContent"></div>

  <script>
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const pathParts = window.location.pathname.split("/");
    const slug = pathParts[pathParts.length - 1];

    function formatViews(num) {
      if (num >= 1_000_000) return (num / 1_000_000).toFixed(1) + "M";
      if (num >= 1_000) return (num / 1_000).toFixed(1) + "K";
      return num;
    }

    if (!slug) {
      document.getElementById("postTitle").textContent = "No slug provided.";
    } else {
      // Query the post by slug
      db.collection("posts").where("slug", "==", slug).limit(1).get()
        .then(snapshot => {
          if (snapshot.empty) {
            document.getElementById("postTitle").textContent = "Post not found.";
            return;
          }

          const doc = snapshot.docs[0];
          const postId = doc.id;        // Firestore document ID
          const post = doc.data();

          document.getElementById("postTitle").textContent = post.title || "Untitled";
          document.getElementById("postCategory").textContent = post.category || "Uncategorized";

          const author = post.author || "Unknown Author";
          const date = post.date ? new Date(post.date).toLocaleDateString() : "Unknown Date";

          // Increment views
          const viewsRef = db.collection("views").doc(postId);
          viewsRef.set({ count: firebase.firestore.FieldValue.increment(1) }, { merge: true })
            .then(() => viewsRef.get())
            .then(viewDoc => {
              const views = viewDoc.exists ? viewDoc.data().count || 1 : 1;
              document.getElementById("postMeta").textContent =
                `By ${author} • ${date} • ${formatViews(views)} views`;
            });

          // Cover image
          if (post.cover) {
            const coverImage = document.getElementById("coverImage");
            coverImage.src = post.cover;
            coverImage.style.display = "block";
          }

          // Article + media
          let html = post.article || "";
          if (post.url) {
            const ext = post.url.split('.').pop().split('?')[0].toLowerCase();
            if (ext === "pdf") html += `<iframe src="${post.url}" height="400"></iframe>`;
            else if (["jpg","jpeg","png","gif"].includes(ext)) html += `<img src="${post.url}" alt="Image">`;
            else if (["mp4","webm"].includes(ext)) html += `<video controls><source src="${post.url}" type="video/${ext}"></video>`;
            else html += `<p><a href="${post.url}" target="_blank">Download File</a></p>`;
          }
          document.getElementById("postContent").innerHTML = html;
        })
        .catch(error => {
          document.getElementById("postTitle").textContent = "Error loading post.";
          console.error(error);
        });
    }
  </script>
</body>
</html>