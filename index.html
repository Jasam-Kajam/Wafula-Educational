<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mpasho-style Homepage</title>
<style>
body { margin:0; font-family: Arial, sans-serif; background: #f9f9f9; }
header { background: #00796b; color: #fff; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; }
header h1 { margin:0; font-size: 24px; }
#breakingNews { white-space: nowrap; overflow: hidden; flex:1; margin-left: 20px; }
#breakingNews a { color: #fff; text-decoration: none; margin-right: 15px; font-weight: bold; }
#contentArea { padding: 20px; }
.category-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: white;
  padding: 10px 20px;
  border-radius: 6px;
  margin: 20px 0 10px;
}
.category-header h2 { margin: 0; font-size: 20px; }
.category-header .see-all { color: #fff; text-decoration: underline; font-size: 14px; }
.category-scroller {
  display: flex;
  overflow-x: auto;
  gap: 15px;
  padding: 10px 0;
}
.post-card {
  flex: 0 0 250px;
  background: #fff;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,.08);
  padding: 10px;
  text-decoration: none;
  color: #2e2e2e;
  transition: transform 0.2s;
}
.post-card:hover { transform: translateY(-3px); }
.post-card img { width: 100%; height: 140px; object-fit: cover; border-radius: 8px; margin-bottom: 8px; }
.post-card .post-title { font-weight: bold; margin-bottom: 5px; font-size: 16px; }
.post-card .post-desc { font-size: 14px; color: #555; }
.skeleton { width: 250px; height: 200px; background: #ddd; border-radius: 12px; }
</style>
</head>
<body>

<header>
  <h1>Mpasho Clone</h1>
  <div id="breakingNews"></div>
</header>

<div id="contentArea">
  <!-- Categories and posts will be injected here -->
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, getDocs, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-lite.js";

const firebaseConfig = {
  apiKey: "AIzaSyAwAxP-MWwNnKP59PA6joil4Ceq10eozlc",
  authDomain: "wafula-s-educational-posts.firebaseapp.com",
  projectId: "wafula-s-educational-posts"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const contentArea = document.getElementById("contentArea");
const categories = ["news", "sports", "business", "courses", "funny", "inspire me", "blogs"];
const colors = ["#00796b", "#6a1b9a", "#f57c00", "#1976d2", "#c2185b", "#2e7d32"];

categories.forEach((cat, i) => {
  const section = document.createElement("section");
  section.id = cat;
  section.className = "category-section";
  const header = document.createElement("div");
  header.className = "category-header";
  header.style.backgroundColor = colors[i % colors.length];
  header.innerHTML = `<h2>${cat.charAt(0).toUpperCase() + cat.slice(1)}</h2> <a href="#${cat}" class="see-all">See All</a>`;
  section.appendChild(header);

  const scroller = document.createElement("div");
  scroller.className = "category-scroller";
  scroller.innerHTML = `<div class="skeleton"></div>`;
  section.appendChild(scroller);

  contentArea.appendChild(section);
});

const cacheKey = "samuwa:firstLoad";
const cached = sessionStorage.getItem(cacheKey);
if (cached) renderPosts(JSON.parse(cached));
else fetchPosts();
fetchBreakingNews();

async function fetchPosts() {
  const q = query(collection(db, "posts"), orderBy("timestamp", "desc"), limit(50));
  const snap = await getDocs(q);
  const data = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  sessionStorage.setItem(cacheKey, JSON.stringify(data));
  renderPosts(data);
}

async function fetchBreakingNews() {
  const q = query(collection(db, "posts"), orderBy("timestamp", "desc"), limit(5));
  const snap = await getDocs(q);
  const data = snap.docs.map(doc => ({ id: doc.id, title: doc.data().title }));
  const marquee = document.getElementById("breakingNews");
  marquee.innerHTML = data.map(d => `<a href="/post.html?id=${d.id}">${d.title}</a>`).join(" â€¢ ");
}

function renderPosts(posts) {
  posts.forEach(post => {
    const cat = (post.category || "uncategorized").toLowerCase();
    const section = document.getElementById(cat);
    if (!section) return;
    const scroller = section.querySelector(".category-scroller");
    scroller.querySelectorAll(".skeleton").forEach(el => el.remove());

    const firstImage = (post.article?.match(/<img[^>]+src="([^">]+)"/) || [])[1] || "";
    const card = document.createElement("a");
    card.href = `/post.html?id=${post.id}`;
    card.className = "post-card";
    card.innerHTML = `
      ${firstImage ? `<img src="${firstImage}" alt="${post.title}">` : ""}
      <div class="post-title">${post.title}</div>
      <div class="post-desc">${post.article?.replace(/<[^>]+>/g, "").split(" ").slice(0,20).join(" ")}...</div>
    `;
    scroller.appendChild(card);
  });
}
</script>

</body>
</html>